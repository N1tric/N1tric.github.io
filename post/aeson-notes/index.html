<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/custom.css">
    <link href="https://fonts.geekzu.org/css2?family=PT+Serif&amp;family=Source+Sans+Pro&amp;display=swap" rel="stylesheet">

    <title>Aeson Notes | Nutr1t07's Blog</title>
  </head>

  <body>
    <div class="container">
      <div class="sidebar">
        <nav>
            <h3 id="logo">Nutr1t07</h3>
            <ul>
                    <li><a href="/">Index</a></li>
                    <li><a href="/page/friends/">Friends</a></li>
            
            </ul>
        <div id="outline" class="outline">
            <text>Outline</text>
            <div class="outline-ul"><ul>
	<li><a href="#hdr:0">Array with Objects</a></li>
<li><a href="#hdr:1">Field with different types</a></li>
</ul>
</ul>
</div>
        </div>

        </nav>
        &nbsp;
</div>

      <div class="content">
        <h3 id="article-title">Aeson Notes</h3>
        


        <div id="article-content"><h4 id="hdr:0">Array with Objects</h4>
<p>Suppose we have the JSON data:</p>
<pre><code>{
  &quot;media_id&quot;: &quot;981538&quot;,
  &quot;tags&quot;: [ {
      &quot;id&quot;: 12227,
      &quot;name&quot;: &quot;english&quot;
    }, {
      &quot;id&quot;: 58971,
      &quot;name&quot;: &quot;japanese&quot;
    } ]
}</code></pre>
<p>We want it to be parsed into the following structure, with the <code>r_tags</code> taking only the name field of tags.</p>
<pre><code>data Result = Result {
    r_id :: Text
  , r_tags :: [Text]
}</code></pre>
<p>The easiest way is to parse via newtype wrapper:</p>
<pre><code>data Result = Result {
    r_media_id :: Text
  , r_tags :: [RTag]
}
instance FromJSON Result where
  parseJSON = withObject &quot;Result&quot; $ \v -&gt; Result
    &lt;$&gt; (v .: &quot;media_id&quot;)
    &lt;*&gt; (v .: &quot;tags&quot;)

newtype RTag = RTag { tag :: Text }
instance FromJSON RTag where
  parseJSON = withObject &quot;RTag&quot; $ \v -&gt;
    RTag &lt;$&gt; ((v .: &quot;name&quot;))</code></pre>
<p>But we can simplify this by removing the <code>RTag</code> wrapper. But first letâ€™s take a look at some Aeson types:</p>
<pre><code>type Array = Vector Value
type Object = HashMap Text Value
parseJSON :: Value -&gt; Parser a
(.:) :: FromJSON a =&gt; Object -&gt; Text -&gt; Parser a</code></pre>
<p>And we can infer that <code>(v .: &quot;tags&quot;)</code> parse tags into an Array(so has type <code>Parser Array</code>), inside which elements are parsed by the instance of <code>RTag</code>. Obviously, if we want to parse the tags directly into <code>[Text]</code>, we need to turn the type of <code>(v .: &quot;tags&quot;)</code>, which is <code>Parser Array</code>, into <code>Parser [Text]</code>.</p>
<p>It can be done using a <code>do</code> block, with a little help from <code>toList</code>:</p>
<pre><code>import Data.Foldable (toList)
import Data.Aeson.Types (Parser)

parseJSON = withObject &quot;Result&quot; $ \v -&gt; Result
  &lt;$&gt; (v .: &quot;media_id&quot;)
  &lt;*&gt; do
    tagArray &lt;- (v .: &quot;tags&quot;) :: Parser Array
    tagObjs &lt;- traverse (parseJSON :: Value -&gt; Parser Object) $ toList tagArray :: Parser [Object]
    traverse (.: &quot;name&quot;) tagObjs</code></pre>
<p>Then remove do block:</p>
<pre><code>(v .: &quot;tags&quot;) :: Parser Array &gt;&gt;= traverse parseJSON . toList &gt;&gt;= traverse (.: &quot;name&quot;)</code></pre>
<h4 id="hdr:1">Field with different types</h4>
<pre><code>&quot;result&quot;: [ {
    &quot;id&quot;: 1531017
    &quot;media_id&quot;: &quot;148011&quot;
  }, {
    &quot;id&quot;: &quot;5137523&quot;
    &quot;media_id&quot;: &quot;135611&quot;
  } ]</code></pre>
<p>Look at the id field above, did you find that it can be either a <code>String</code> or <code>Int</code>? It can be parsed using a <code>parseId</code> function.</p>
<pre><code>parseId :: Value -&gt; Parser Text
parseId (Number o) = pure $ (fst . Text.breakOn &quot;.&quot;) $ Text.pack $ show o
parseId (String o) = pure o
parseId _ = mzero</code></pre>
<p>Within the structure:</p>
<pre><code>data Result = Result {
    r_wtf_id :: Text.Text
  , r_media_id :: Text.Text
}
instance FromJSON Result where
  parseJSON = withObject &quot;Result&quot; $ \v -&gt; Result
    &lt;$&gt; ((v .: &quot;id&quot;) &gt;&gt;= parseId)
    &lt;*&gt; (v .: &quot;media_id&quot;)</code></pre>
</div>
      </div>
    </div>
    


  </body>
</html>
